name: Publish
on:
  push:
    branches:
      - main

permissions: read-all

jobs:
  check:
    name: Check
    runs-on: ubuntu-24.04
    outputs:
      released: ${{ steps.version.outputs.released }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0 # To fetch all tags
          persist-credentials: false
      - name: Check released
        id: version
        run: |
          VERSION="$(grep 'version=' < Containerfile | awk -F'"' '{print $2}')"
          echo "version=v${VERSION}" >> "${GITHUB_OUTPUT}"
          if [ -n "$(git tag --list "v${VERSION}")" ]; then
            echo 'released=true' >> "${GITHUB_OUTPUT}"
          else
            echo 'released=false' >> "${GITHUB_OUTPUT}"
          fi
  git:
    name: Git
    runs-on: ubuntu-24.04
    if: ${{ needs.check.outputs.released == 'false' }}
    permissions:
      contents: write # To push a branch
    needs:
      - check
    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0
      - name: Get major version
        id: version
        env:
          VERSION: ${{ needs.check.outputs.version }}
        run: |
          echo "result=${VERSION%%.*}" >>"${GITHUB_OUTPUT}"
      - name: Create release tag
        env:
          VERSION: ${{ needs.check.outputs.version }}
        run: |
          git tag "${VERSION}"
          git push origin "${VERSION}"
      - name: Update major version branch
        env:
          MAJOR_VERSION: ${{ steps.version.outputs.result }}
        run: git push origin "HEAD:${MAJOR_VERSION}"
  docker:
    name: Docker Hub
    runs-on: ubuntu-24.04
    if: ${{ needs.check.outputs.released == 'false' }}
    permissions:
      id-token: write # To perform keyless signing with cosign
    environment:
      name: docker
      url: https://hub.docker.com/r/ericornelissen/js-re-scan
    needs:
      - check
    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false
      - name: Get cosign version
        id: versions
        run: |
          COSIGN_VERSION="$(grep cosign < .tool-versions | awk '{print $2}')"
          echo "cosign=${COSIGN_VERSION}" >>"${GITHUB_OUTPUT}"
      - name: Install cosign
        uses: sigstore/cosign-installer@d58896d6a1865668819e1d91763c7751a165e159 # v3.9.2
        with:
          cosign-release: v${{ steps.versions.outputs.cosign }}
      - name: Install Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1
      - name: Log in to Docker Hub
        uses: docker/login-action@184bdaa0721073962dff0199f1fb9940f07167d1 # v3.5.0
        with:
          username: ${{ vars.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Build and push to Docker Hub
        id: container
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: .
          file: Containerfile
          push: true
          platforms: >-
            linux/amd64,
            linux/arm64
          tags: >-
            docker.io/ericornelissen/js-re-scan:latest,
            docker.io/ericornelissen/js-re-scan:${{ needs.check.outputs.version }}
      - name: Sign container image
        env:
          IMAGE_DIGEST: ${{ steps.container.outputs.digest }}
          REF: ${{ github.sha }}
          REPO: ${{ github.repository }}
          WORKFLOW: ${{ github.workflow }}
        run: |
          cosign sign --yes \
            -a "repo=${REPO}" \
            -a "workflow=${WORKFLOW}" \
            -a "ref=${REF}" \
            "docker.io/ericornelissen/js-re-scan@${IMAGE_DIGEST}"
  ghcr:
    name: GHCR
    runs-on: ubuntu-24.04
    if: ${{ needs.check.outputs.released == 'false' }}
    permissions:
      id-token: write # To perform keyless signing with cosign
      packages: write # To push an image to GHCR
    environment:
      name: ghcr
      url: https://github.com/ericcornelissen/js-regex-security-scanner/pkgs/container/js-re-scan
    needs:
      - check
    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false
      - name: Get cosign version
        id: versions
        run: |
          COSIGN_VERSION="$(grep cosign < .tool-versions | awk '{print $2}')"
          echo "cosign=${COSIGN_VERSION}" >>"${GITHUB_OUTPUT}"
      - name: Install cosign
        uses: sigstore/cosign-installer@d58896d6a1865668819e1d91763c7751a165e159 # v3.9.2
        with:
          cosign-release: v${{ steps.versions.outputs.cosign }}
      - name: Install Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1
      - name: Log in to GHCR
        uses: docker/login-action@184bdaa0721073962dff0199f1fb9940f07167d1 # v3.5.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push to GHCR
        id: container
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: .
          file: Containerfile
          push: true
          platforms: >-
            linux/amd64,
            linux/arm64
          tags: >-
            ghcr.io/ericcornelissen/js-re-scan:latest,
            ghcr.io/ericcornelissen/js-re-scan:${{ needs.check.outputs.version }}
      - name: Sign container image
        env:
          IMAGE_DIGEST: ${{ steps.container.outputs.digest }}
          REF: ${{ github.sha }}
          REPO: ${{ github.repository }}
          WORKFLOW: ${{ github.workflow }}
        run: |
          cosign sign --yes \
            -a "repo=${REPO}" \
            -a "workflow=${WORKFLOW}" \
            -a "ref=${REF}" \
            "ghcr.io/ericcornelissen/js-re-scan@${IMAGE_DIGEST}"
