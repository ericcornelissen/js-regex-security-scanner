name: Publish
on:
  push:
    tags:
      - v*

permissions: read-all

jobs:
  branch:
    name: Branch
    runs-on: ubuntu-22.04
    permissions:
      contents: write # To push a branch
    needs:
      - validate
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@8ca2b8b2ece13480cda6dacd3511b49857a23c09 # v2.5.1
        with:
          disable-sudo: true
          egress-policy: block
          allowed-endpoints: >
            github.com:443
      - name: Checkout repository
        uses: actions/checkout@3df4ab11eba7bda6032a0b82a6bb43b11571feac # v4.0.0
        with:
          fetch-depth: 0
      - name: Get major version
        uses: actions/github-script@d7906e4ad0b1822421a7e6a35d5ca353c962f410 # v6.4.1
        id: version
        with:
          result-encoding: string
          script: |
            const ref = context.ref
            const tag = ref.replace(/^refs\/tags\//, "")
            const major = tag.replace(/\.\d+\.\d+$/, "")
            return major
      - name: Update release branch
        env:
          MAJOR_VERSION: ${{ steps.version.outputs.result }}
        run: git push origin "HEAD:$MAJOR_VERSION"
  docker-hub:
    name: Docker Hub
    runs-on: ubuntu-22.04
    permissions:
      id-token: write # To perform keyless signing with cosign
    environment:
      name: docker
      url: https://hub.docker.com/r/ericornelissen/js-re-scan
    needs:
      - validate
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@8ca2b8b2ece13480cda6dacd3511b49857a23c09 # v2.5.1
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            auth.docker.io:443
            fulcio.sigstore.dev:443
            github.com:443
            index.docker.io:443
            nodejs.org:443
            objects.githubusercontent.com:443
            production.cloudflare.docker.com:443
            raw.githubusercontent.com:443
            registry-1.docker.io:443
            registry.npmjs.org:443
            rekor.sigstore.dev:443
            sigstore-tuf-root.storage.googleapis.com:443
            storage.googleapis.com:443
            tuf-repo-cdn.sigstore.dev:443
      - name: Checkout repository
        uses: actions/checkout@3df4ab11eba7bda6032a0b82a6bb43b11571feac # v4.0.0
      - name: Get version
        uses: actions/github-script@d7906e4ad0b1822421a7e6a35d5ca353c962f410 # v6.4.1
        id: version
        with:
          result-encoding: string
          script: |
            const ref = context.ref
            const tag = ref.replace(/^refs\/tags\//, "")
            return tag
      - name: Get cosign version
        id: versions
        run: |
          COSIGN_VERSION="$(grep cosign < .tool-versions | awk '{print $2}')"
          echo "cosign=$COSIGN_VERSION" >> "$GITHUB_OUTPUT"
      - name: Install cosign
        uses: sigstore/cosign-installer@11086d25041f77fe8fe7b9ea4e48e3b9192b8f19 # v3.1.2
        with:
          cosign-release: v${{ steps.versions.outputs.cosign }}
      - name: Log in to Docker Hub
        uses: docker/login-action@465a07811f14bebb1938fbed4728c6a1ff8901fc # v2.2.0
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Build and push to Docker Hub
        id: docker_hub
        uses: docker/build-push-action@0a97817b6ade9f46837855d676c4cca3a2471fc9 # v4.2.1
        with:
          context: .
          push: true
          tags: >-
            ericornelissen/js-re-scan:latest,
            ericornelissen/js-re-scan:${{ steps.version.outputs.result }}
      - name: Sign container image
        env:
          IMAGE_DIGEST: ${{ steps.docker_hub.outputs.digest }}
          REF: ${{ github.sha }}
          REPO: ${{ github.repository }}
          WORKFLOW: ${{ github.workflow }}
        run: |
          cosign sign --yes \
            -a "repo=$REPO" \
            -a "workflow=$WORKFLOW" \
            -a "ref=$REF" \
            "docker.io/ericornelissen/js-re-scan@$IMAGE_DIGEST"
  validate:
    name: Validate
    runs-on: ubuntu-22.04
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@8ca2b8b2ece13480cda6dacd3511b49857a23c09 # v2.5.1
        with:
          disable-sudo: true
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            auth.docker.io:443
            artifactcache.actions.githubusercontent.com:443
            files.pythonhosted.org:443
            fulcio.sigstore.dev:443
            github.com:443
            gitlab.com:443
            nodejs.org:443
            objects.githubusercontent.com:443
            production.cloudflare.docker.com:443
            pypi.org:443
            registry-1.docker.io:443
            registry.npmjs.org:443
            rekor.sigstore.dev:443
            sigstore-tuf-root.storage.googleapis.com:443
            toolbox-data.anchore.io:443
            tuf-repo-cdn.sigstore.dev:443
      - name: Checkout repository
        uses: actions/checkout@3df4ab11eba7bda6032a0b82a6bb43b11571feac # v4.0.0
        with:
          submodules: true
      - name: Install Node.js
        uses: actions/setup-node@5e21ff4d9bc1a8cf6de233a3057d20ec6b3fb69d # v3.8.1
        with:
          cache: npm
          node-version-file: .nvmrc
      - name: Install tooling
        uses: asdf-vm/actions/install@6a442392015fbbdd8b48696d41e0051b2698b2e4 # v2.2.0
      - name: Verify project validity
        run: make verify
